#!/bin/sh

#############################
# Backup & Restore bash-script
# by s3n0, 2019-10-03
#############################
# simple bash script for backing up and restoring
# user-defined settings, files or folders in Enigma2
#############################

BACKUP_DIR="/media/hdd/backup_folder"

ARCHIVE_FILENAME="backup-enigma"     # Note: The timestamp is automatically added at the end of the file name and the file extension is ".tar.gz"

LIST="
/etc/enigma2/

/etc/tuxbox/*.xml
/etc/auto.network
/etc/cron/crontabs/root

/usr/script/

/usr/bin/oscam
/etc/init.d/softcam
/etc/rc?.d/*softcam
/etc/tuxbox/config/oscam/

/usr/bin/udpxy
/etc/init.d/udpxy
/etc/rc?.d/*udpxy

/usr/lib/enigma2/python/Plugins/Extensions/EpgDownloadReplace/
/usr/lib/enigma2/python/Plugins/Extensions/ChocholousekPicons/
/usr/lib/enigma2/python/Plugins/Extensions/Remoover/
/usr/lib/enigma2/python/Plugins/Extensions/YouTube/

/usr/share/enigma2/MetrixHD/skinparts/infobar-mod_by_s3n0/

/usr/share/enigma2/picon/
"

#############################
#############################

LIST=$(echo $LIST | tr "\n" " ")




init_4_and_check() {
    echo "Stopping the Enigma..."
    init 4
    if [ $? -eq 0 ]; then
        echo "...done."
        sleep 2
    else
        echo -e "...failed ! Backup & Restore script will be terminated !"
        exit 1    
    fi
}

do_backup() {
    echo "-----------------------"
    if [ "$1" != "quickly" ]; then         # ignoring the init command to start or stop the Enigma2, if the user choice was '--backup-quickly' argument
        # store the Standby power state when the script starts:  5 = to turn the Enigma2 into Standby ,  4 = to wake-up the Enigma2 from Standby
        [ "$(wget -q -O - http://127.0.0.1/web/powerstate | grep '</e2instandby>' | cut -f 1)" == "true" ] && previous_standby_state=5 || previous_standby_state=4
        init_4_and_check
    fi
    echo "Creating the archive file:"
    echo "    $BACKUP_DIR/$ARCHIVE_FILENAME-`date '+%Y-%m-%d-%H%M%S'`.tar.gz"
    echo "Files and folders to compress:"
    echo "    $LIST "
    echo "-----------------------"
    mkdir -p $BACKUP_DIR
    tar --ignore-failed-read --exclude='/etc/enigma2/epg.dat' -czpf $BACKUP_DIR/$ARCHIVE_FILENAME-`date '+%Y-%m-%d-%H%M%S'`.tar.gz $LIST
    ls -l $BACKUP_DIR/$ARCHIVE_FILENAME*
    if [ "$1" != "quickly" ]; then         # ignoring the init command to start or stop the Enigma2, if the user choice was '--backup-quickly' argument
        init 3
        echo "Starting the Enigma..."
        echo "...waiting 120 seconds for the Enigma to start"
        sleep 120
        echo "...force the Enigma power to its original state: $([ $previous_standby_state == 5 ] && echo 'turn into Standby' || echo 'wake-up from Standby')"
        wget -q -O - http://127.0.0.1/web/powerstate?newstate=$previous_standby_state > /dev/null 2>&1
        echo "...done."
    fi
    echo "-----------------------"
}

do_restore() {
    if [ -f $BACKUP_DIR/$ARCHIVE_FILENAME*.tar.gz ]; then
        LATEST_FILE=$(ls -tc $BACKUP_DIR/$ARCHIVE_FILENAME*.tar.gz | head -n 1)
        echo "-----------------------"
        init_4_and_check
        echo "Extracting the latest archive file:"
        echo "   $LATEST_FILE "
        echo "-----------------------"
        tar --overwrite -xzphf $LATEST_FILE
        init 3
        echo "-----------------------"
    else
        echo "ERROR! No archive files $ARCHIVE_FILENAME*.tar.gz found in the $BACKUP_DIR directory!"
        exit 1
    fi
}







case "$1" in
    b|backup|-b|--backup)
        do_backup "standard"
        ;;
    bq|backup-quickly|-bq|--backup-quickly)
        do_backup "quickly"
        ;;
    r|restore|-r|--restore)
        do_restore
        ;; 
    *)
        echo -e "\nUSAGE:"
        echo -e "\t $0 <ARGUMENT>"
        echo -e "ARGUMENT:"
        echo -e "\t b|backup|-b|--backup \n\t\t ...to backup all user-defined files & folders"
        echo -e "\t bq|backup-quickly|-bq|--backup-quickly \n\t\t ...to backup all user-defined files & folders without stopping the Enigma during the backup process"
        echo -e "\t r|restore|-r|--restore \n\t\t ...to restore all user-defined files & folders"
        ;;
esac





exit 0
